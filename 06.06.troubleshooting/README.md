# Домашнее задание к занятию "6.6. Troubleshooting"

## Задача 1

Перед выполнением задания ознакомьтесь с документацией по [администрированию MongoDB](https://docs.mongodb.com/manual/administration/).

Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD операция в MongoDB и её 
нужно прервать. 

Вы как инженер поддержки решили произвести данную операцию:
- напишите список операций, которые вы будете производить для остановки запроса пользователя

```
1. запустить встроенный мониторинг - db.enableFreeMonitoring()$
2. найти долгие запросы - db.currentUP({"secs.running": {$gte: N}}) (N - время запроса);
3. завершить запрос - db.killOp(id).
```
- предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB

```
1. установить время выполнения - maxTimeMS()
2. для запросов чтения - использовать реплики;
   для запросов записи - проверить настройки durability/
```

## Задача 2

Перед выполнением задания познакомьтесь с документацией по [Redis latency troobleshooting](https://redis.io/topics/latency).

Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. 
Причем отношение количества записанных key-value значений к количеству истёкших значений есть величина постоянная и
увеличивается пропорционально количеству реплик сервиса. 

При масштабировании сервиса до N реплик вы увидели, что:
- сначала рост отношения записанных значений к истекшим
- Redis блокирует операции записи

Как вы думаете, в чем может быть проблема?

```
Скорее всего проблемы возникает при удалении истекших ключей. Этот процесс запускается каждые 100 мс и удаляет 
не более 200 ключей. Если общее количество истекших ключей превышает 25%, то БД блокируется, пока это количество 
не уменьшится до 25%.
```
 
## Задача 3

Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей, в таблицах базы,
пользователи начали жаловаться на ошибки вида:
```python
InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
```

Как вы думаете, почему это начало происходить и как локализовать проблему?

```
Данная ошибка может возникнуть при сетевых проблемах или, когда много строк БД отправляются как часть одного 
запроса и система становится недоступна. Еще может возникать ошибка при первоначальном подключении клиента к БД, 
когда время выделенное на эту операцию мало.
```
Какие пути решения данной проблемы вы можете предложить?

```
Можно увеличить параметры connect_timeout, interactive_timeout, wait_timeout, net_read_timeout, max_connections, 
чтобы увелить время ожидания ответа на запрос и увеличить число одновременных соединений. Увеличить количество 
оперативной памяти. Можно также попробовать дробить крупные запросы на части, ну и проверить сетевые параметры.
```

## Задача 4

Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с 
большим объемом данных лучше, чем MySQL.

После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:

`postmaster invoked oom-killer`

Как вы думаете, что происходит?

```
Это указывает на то, что postgres нехвает памяти и oom-killer уничтожил процесс, который потребляет больше всего 
памяти.
```

Как бы вы решили данную проблему?

```
Лучшим решением является изменение поведения ядра таким образом, чтобы оно не выделяло слишком много памяти. 
Это делается путем выбора режима строгой перегрузки через sysctl: sysctl -w vm.overcommit_memory = 2. 
Также можно увеличить значение swap-файла и/или количество оперативной памяти.
```
